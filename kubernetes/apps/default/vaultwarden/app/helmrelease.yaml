---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vaultwarden
spec:
  interval: 1h
  timeout: 10m
  chart:
    spec:
      chart: vaultwarden
      version: "0.25.0"
      sourceRef:
        kind: HelmRepository
        name: vaultwarden
  values:
    domain: "https://passwords.gurzil.org"

    # Admin token for admin panel (optional)
    adminToken:
      existingSecret: vaultwarden-admin
      existingSecretKey: token

    # SSO/OIDC Configuration via extraVars and extraSecrets
    image:
      extraSecrets:
        - key: SSO_CLIENT_ID
          secretName: vaultwarden-oidc
          secretKey: client-id
        - key: SSO_CLIENT_SECRET
          secretName: vaultwarden-oidc
          secretKey: client-secret
      extraVars:
        - key: SSO_ENABLED
          value: "true"
        - key: SSO_AUTHORITY
          value: "https://login.gurzil.org/application/o/passwords/"
        - key: SSO_SIGNUPS_MATCH_EMAIL
          value: "true"
        - key: SSO_ALLOW_INSECURE_HTTP
          value: "false"

    # Signups disabled - only via SSO
    signupsAllowed: "false"

    # Data persistence on Longhorn
    data:
      name: vaultwarden-data
      size: 1Gi
      class: longhorn-replicated
      accessMode: ReadWriteOnce
      keepPvc: true

    # Service
    service:
      type: ClusterIP
      port: 80

    # Resources
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Security context
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

    # Ingress disabled - using HTTPRoute
    ingress:
      enabled: false
