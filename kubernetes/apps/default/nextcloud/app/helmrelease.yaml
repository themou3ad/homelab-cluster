---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nextcloud
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: nextcloud
  values:
    image:
      registry: docker.io
      repository: bitnami/nextcloud
      tag: 30.0.4-debian-12-r0

    nextcloudHost: nextcloud.gurzil.org
    nextcloudUsername: admin

    # Reference secret for sensitive values
    existingSecret: nextcloud-credentials

    # PostgreSQL database
    postgresql:
      enabled: true
      auth:
        database: nextcloud
        username: nextcloud
        existingSecret: nextcloud-db-credentials
        secretKeys:
          userPasswordKey: password
      primary:
        persistence:
          enabled: true
          size: 8Gi

    # Redis for caching
    redis:
      enabled: true
      auth:
        enabled: false

    # Persistence
    persistence:
      enabled: true
      size: 50Gi

    # Ingress disabled - we'll use HTTPRoute
    ingress:
      enabled: false

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

    # Extra environment for OIDC
    extraEnvVars:
      - name: NEXTCLOUD_TRUSTED_DOMAINS
        value: "nextcloud.gurzil.org"

    # OIDC Configuration via config file
    nextcloudConfigs:
      oidc.config.php: |-
        <?php
        $CONFIG = array(
          'allow_user_to_change_display_name' => false,
          'lost_password_link' => 'disabled',
          'oidc_login_provider_url' => 'https://login.gurzil.org/application/o/nextcloud/',
          'oidc_login_client_id' => getenv('OIDC_CLIENT_ID'),
          'oidc_login_client_secret' => getenv('OIDC_CLIENT_SECRET'),
          'oidc_login_auto_redirect' => false,
          'oidc_login_end_session_redirect' => true,
          'oidc_login_button_text' => 'Se connecter avec Authentik',
          'oidc_login_hide_password_form' => false,
          'oidc_login_use_id_token' => true,
          'oidc_login_attributes' => array(
            'id' => 'preferred_username',
            'name' => 'name',
            'mail' => 'email',
            'groups' => 'groups',
          ),
          'oidc_login_default_group' => 'users',
          'oidc_login_use_external_storage' => false,
          'oidc_login_scope' => 'openid profile email groups',
          'oidc_login_proxy_ldap' => false,
          'oidc_login_disable_registration' => false,
          'oidc_login_redir_fallback' => false,
          'oidc_login_tls_verify' => true,
          'oidc_create_groups' => true,
          'oidc_login_webdav_enabled' => false,
          'oidc_login_password_authentication' => false,
          'oidc_login_public_key_caching_time' => 86400,
          'oidc_login_min_time_between_jwks_requests' => 10,
          'oidc_login_well_known_caching_time' => 86400,
          'oidc_login_update_avatar' => false,
        );

    # Mount OIDC credentials as env vars
    extraEnvVarsSecret: nextcloud-oidc
    extraVolumeMounts:
      - name: oidc-env
        mountPath: /opt/bitnami/nextcloud/config/oidc.config.php
        subPath: oidc.config.php
