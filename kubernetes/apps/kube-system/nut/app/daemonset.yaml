---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nut
  namespace: kube-system
  labels:
    app: nut
    app.kubernetes.io/name: nut
spec:
  selector:
    matchLabels:
      app: nut
  template:
    metadata:
      labels:
        app: nut
        app.kubernetes.io/name: nut
    spec:
      serviceAccountName: nut
      hostNetwork: false
      nodeSelector:
        kubernetes.io/hostname: gurzil-one

      initContainers:
        # Download kubectl and talosctl binaries for shutdown script
        - name: init-tools
          image: alpine:3.20
          command:
            - sh
            - -c
            - |
              set -e
              apk add --no-cache curl

              echo "Downloading kubectl..."
              curl -sLo /tools/kubectl "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
              chmod +x /tools/kubectl

              echo "Downloading talosctl..."
              curl -sLo /tools/talosctl "https://github.com/siderolabs/talos/releases/download/v1.9.0/talosctl-linux-amd64"
              chmod +x /tools/talosctl

              echo "Tools downloaded successfully"
          volumeMounts:
            - name: tools
              mountPath: /tools

        # Create shutdown and notify scripts
        - name: init-scripts
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat > /scripts/shutdown.sh << 'EOFSH'
              #!/bin/sh
              set -e
              export PATH="/tools:$PATH"

              echo "$(date): UPS shutdown triggered - starting graceful shutdown sequence"

              # Send notification
              /scripts/notify.sh "SHUTDOWN" "Arret systeme en cours - UPS batterie critique"

              # Get battery status for logging
              BATTERY_CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "unknown")
              BATTERY_RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "unknown")
              echo "$(date): Battery charge: ${BATTERY_CHARGE}%, Runtime: ${BATTERY_RUNTIME}s"

              # Drain the Kubernetes node
              echo "$(date): Draining Kubernetes node gurzil-one..."
              kubectl drain gurzil-one \
                  --ignore-daemonsets \
                  --delete-emptydir-data \
                  --force \
                  --grace-period=60 \
                  --timeout=120s 2>&1 || echo "Warning: Node drain had issues, continuing with shutdown"

              echo "$(date): Node drain complete, initiating Talos shutdown..."

              # Shutdown Talos node
              talosctl shutdown \
                  --talosconfig /etc/talos/talosconfig \
                  --nodes 192.168.1.162 2>&1

              echo "$(date): Shutdown command sent to Talos"
              EOFSH

              cat > /scripts/notify.sh << 'EOFNOTIFY'
              #!/bin/sh
              NOTIFYTYPE="${1:-UNKNOWN}"
              MESSAGE="${UPSNAME:-ups}: ${2:-$NOTIFYTYPE}"

              case "$NOTIFYTYPE" in
                  ONLINE)
                      PRIORITY="default"
                      TAGS="white_check_mark,zap"
                      TITLE="UPS: Alimentation Retablie"
                      ;;
                  ONBATT)
                      PRIORITY="high"
                      TAGS="warning,battery"
                      TITLE="UPS: Coupure de Courant"
                      ;;
                  LOWBATT)
                      PRIORITY="urgent"
                      TAGS="rotating_light,battery"
                      TITLE="UPS: Batterie Faible"
                      ;;
                  FSD|SHUTDOWN)
                      PRIORITY="urgent"
                      TAGS="skull,electric_plug"
                      TITLE="UPS: Arret Systeme"
                      ;;
                  COMMBAD|NOCOMM)
                      PRIORITY="high"
                      TAGS="x,electric_plug"
                      TITLE="UPS: Communication Perdue"
                      ;;
                  REPLBATT)
                      PRIORITY="default"
                      TAGS="wrench,battery"
                      TITLE="UPS: Batterie a Remplacer"
                      ;;
                  *)
                      PRIORITY="default"
                      TAGS="information_source"
                      TITLE="UPS: Notification"
                      ;;
              esac

              BATTERY_INFO=""
              if command -v upsc >/dev/null 2>&1; then
                  CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "N/A")
                  RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "N/A")
                  if [ "$CHARGE" != "N/A" ] && [ "$RUNTIME" != "N/A" ]; then
                      RUNTIME_MIN=$((RUNTIME / 60))
                      BATTERY_INFO=" | Batterie: ${CHARGE}% - Autonomie: ${RUNTIME_MIN}min"
                  fi
              fi

              curl -s \
                  -H "Title: ${TITLE}" \
                  -H "Priority: ${PRIORITY}" \
                  -H "Tags: ${TAGS}" \
                  -d "${MESSAGE}${BATTERY_INFO}" \
                  "http://ntfy.default.svc.cluster.local/alertes" || true

              echo "$(date): Notification sent: ${NOTIFYTYPE} - ${MESSAGE}"
              EOFNOTIFY

              chmod +x /scripts/*.sh
              echo "Scripts created"
          volumeMounts:
            - name: scripts
              mountPath: /scripts

      containers:
        # NUT server (upsd + driver + upsmon) - all-in-one container
        - name: nut-server
          image: instantlinux/nut-upsd:2.8.1-r0
          ports:
            - name: nut
              containerPort: 3493
              protocol: TCP
          env:
            # UPS configuration
            - name: NAME
              value: "ups"
            - name: DRIVER
              value: "usbhid-ups"
            - name: PORT
              value: "auto"
            - name: DESCRIPTION
              value: "Master U Power UPS"
            # API user for external access
            - name: API_USER
              value: "admin"
            - name: API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_ADMIN_PASSWORD
            # Monitor user
            - name: MONITOR_USER
              value: "upsmon"
            - name: MONITOR_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_MONITOR_PASSWORD
            # Shutdown configuration
            - name: SHUTDOWNCMD
              value: "/scripts/shutdown.sh"
          volumeMounts:
            - name: usb
              mountPath: /dev/bus/usb
            - name: scripts
              mountPath: /scripts
            - name: tools
              mountPath: /tools
            - name: talosconfig
              mountPath: /etc/talos
              readOnly: true
          securityContext:
            privileged: true
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi

        # Prometheus exporter for NUT metrics
        - name: nut-exporter
          image: ghcr.io/druggeri/nut_exporter:3.1.1
          command:
            - /nut_exporter
            - --nut.server=localhost
            - --nut.username=admin
            - --web.listen-address=:9199
          ports:
            - name: metrics
              containerPort: 9199
              protocol: TCP
          env:
            - name: NUT_EXPORTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_ADMIN_PASSWORD
          resources:
            requests:
              cpu: 5m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
          livenessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 30
            periodSeconds: 10

      volumes:
        - name: scripts
          emptyDir: {}
        - name: tools
          emptyDir: {}
        - name: usb
          hostPath:
            path: /dev/bus/usb
            type: Directory
        - name: talosconfig
          secret:
            secretName: nut-secrets
            items:
              - key: talosconfig
                path: talosconfig

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
