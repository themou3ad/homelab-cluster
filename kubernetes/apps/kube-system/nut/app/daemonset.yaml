---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nut
  namespace: kube-system
  labels:
    app: nut
    app.kubernetes.io/name: nut
spec:
  selector:
    matchLabels:
      app: nut
  template:
    metadata:
      labels:
        app: nut
        app.kubernetes.io/name: nut
    spec:
      serviceAccountName: nut
      hostNetwork: false
      nodeSelector:
        kubernetes.io/hostname: gurzil-one

      initContainers:
        # Download kubectl and talosctl binaries for shutdown script
        - name: init-tools
          image: alpine:3.20
          command:
            - sh
            - -c
            - |
              set -e
              apk add --no-cache curl

              echo "Downloading kubectl..."
              curl -sLo /tools/kubectl "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
              chmod +x /tools/kubectl

              echo "Downloading talosctl..."
              curl -sLo /tools/talosctl "https://github.com/siderolabs/talos/releases/download/v1.9.0/talosctl-linux-amd64"
              chmod +x /tools/talosctl

              echo "Tools downloaded successfully"
          volumeMounts:
            - name: tools
              mountPath: /tools

        # Prepare upsmon.conf with password substitution
        - name: init-upsmon-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # Copy and substitute password in upsmon.conf
              sed "s/__PASSWORD_PLACEHOLDER__/$${NUT_ADMIN_PASSWORD}/g" /config-template/upsmon.conf > /nut-config/upsmon.conf
              chmod 640 /nut-config/upsmon.conf
              cat /nut-config/upsmon.conf | head -5
              echo "upsmon.conf configured"
          env:
            - name: NUT_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_ADMIN_PASSWORD
          volumeMounts:
            - name: nut-config-template
              mountPath: /config-template
            - name: nut-config
              mountPath: /nut-config

        # Create shutdown and notify scripts
        - name: init-scripts
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat > /scripts/shutdown.sh << 'EOFSH'
              #!/bin/sh
              set -e
              export PATH="/tools:$PATH"

              echo "$(date): UPS shutdown triggered - starting graceful shutdown sequence"

              # Send notification
              /scripts/notify.sh "SHUTDOWN" "Arret systeme en cours - UPS batterie critique"

              # Get battery status for logging
              BATTERY_CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "unknown")
              BATTERY_RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "unknown")
              echo "$(date): Battery charge: ${BATTERY_CHARGE}%, Runtime: ${BATTERY_RUNTIME}s"

              # Drain the Kubernetes node
              echo "$(date): Draining Kubernetes node gurzil-one..."
              kubectl drain gurzil-one \
                  --ignore-daemonsets \
                  --delete-emptydir-data \
                  --force \
                  --grace-period=60 \
                  --timeout=120s 2>&1 || echo "Warning: Node drain had issues, continuing with shutdown"

              echo "$(date): Node drain complete, initiating Talos shutdown..."

              # Shutdown Talos node
              talosctl shutdown \
                  --talosconfig /etc/talos/talosconfig \
                  --nodes 192.168.1.162 2>&1

              echo "$(date): Shutdown command sent to Talos"
              EOFSH

              cat > /scripts/notify.sh << 'EOFNOTIFY'
              #!/bin/sh
              NOTIFYTYPE="${1:-UNKNOWN}"
              MESSAGE="${UPSNAME:-ups}: ${2:-$NOTIFYTYPE}"

              case "$NOTIFYTYPE" in
                  ONLINE)
                      PRIORITY="default"
                      TAGS="white_check_mark,zap"
                      TITLE="UPS: Alimentation Retablie"
                      ;;
                  ONBATT)
                      PRIORITY="high"
                      TAGS="warning,battery"
                      TITLE="UPS: Coupure de Courant"
                      ;;
                  LOWBATT)
                      PRIORITY="urgent"
                      TAGS="rotating_light,battery"
                      TITLE="UPS: Batterie Faible"
                      ;;
                  FSD|SHUTDOWN)
                      PRIORITY="urgent"
                      TAGS="skull,electric_plug"
                      TITLE="UPS: Arret Systeme"
                      ;;
                  COMMBAD|NOCOMM)
                      PRIORITY="high"
                      TAGS="x,electric_plug"
                      TITLE="UPS: Communication Perdue"
                      ;;
                  REPLBATT)
                      PRIORITY="default"
                      TAGS="wrench,battery"
                      TITLE="UPS: Batterie a Remplacer"
                      ;;
                  *)
                      PRIORITY="default"
                      TAGS="information_source"
                      TITLE="UPS: Notification"
                      ;;
              esac

              BATTERY_INFO=""
              if command -v upsc >/dev/null 2>&1; then
                  CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "N/A")
                  RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "N/A")
                  if [ "$CHARGE" != "N/A" ] && [ "$RUNTIME" != "N/A" ]; then
                      RUNTIME_MIN=$((RUNTIME / 60))
                      BATTERY_INFO=" | Batterie: ${CHARGE}% - Autonomie: ${RUNTIME_MIN}min"
                  fi
              fi

              wget --quiet \
                  --header="Title: ${TITLE}" \
                  --header="Priority: ${PRIORITY}" \
                  --header="Tags: ${TAGS}" \
                  --post-data="${MESSAGE}${BATTERY_INFO}" \
                  -O - \
                  "http://ntfy.default.svc.cluster.local/alertes" 2>/dev/null || true

              echo "$(date): Notification sent: ${NOTIFYTYPE} - ${MESSAGE}"
              EOFNOTIFY

              chmod +x /scripts/*.sh
              echo "Scripts created"
          volumeMounts:
            - name: scripts
              mountPath: /scripts

      containers:
        # NUT server (upsd + driver + upsmon) - all-in-one container
        - name: nut-server
          image: instantlinux/nut-upsd:2.8.1-r0
          ports:
            - name: nut
              containerPort: 3493
              protocol: TCP
          env:
            # UPS configuration
            - name: NAME
              value: "ups"
            - name: DRIVER
              value: "usbhid-ups"
            - name: PORT
              value: "auto"
            - name: DESCRIPTION
              value: "Master U Power UPS"
            # API user for external access
            - name: API_USER
              value: "admin"
            - name: API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_ADMIN_PASSWORD
            # Monitor user
            - name: MONITOR_USER
              value: "upsmon"
            - name: MONITOR_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nut-secrets
                  key: NUT_MONITOR_PASSWORD
            # Shutdown configuration
            - name: SHUTDOWNCMD
              value: "/scripts/shutdown.sh"
          volumeMounts:
            - name: usb
              mountPath: /dev/bus/usb
            - name: scripts
              mountPath: /scripts
            - name: tools
              mountPath: /tools
            - name: talosconfig
              mountPath: /etc/talos
              readOnly: true
            - name: nut-config
              mountPath: /etc/nut/local
          securityContext:
            privileged: true
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi

        # Prometheus exporter for NUT metrics (simple Python exporter)
        - name: nut-exporter
          image: alpine:3.20
          command:
            - sh
            - -c
            - |
              # Install dependencies
              apk add --no-cache python3 py3-pip nut
              pip3 install --break-system-packages prometheus-client

              # Create exporter script
              cat > /exporter.py << 'PYEOF'
              #!/usr/bin/env python3
              import subprocess
              import time
              import sys
              from prometheus_client import start_http_server, Gauge, Info

              # Metrics
              battery_charge = Gauge('nut_battery_charge_percent', 'Battery charge percentage', ['ups'])
              battery_runtime = Gauge('nut_battery_runtime_seconds', 'Battery runtime in seconds', ['ups'])
              input_voltage = Gauge('nut_input_voltage_volts', 'Input voltage', ['ups'])
              output_voltage = Gauge('nut_output_voltage_volts', 'Output voltage', ['ups'])
              ups_load = Gauge('nut_ups_load_percent', 'UPS load percentage', ['ups'])
              ups_status = Gauge('nut_ups_status', 'UPS status (1=OL online, 0=OB on battery)', ['ups'])
              input_frequency = Gauge('nut_input_frequency_hertz', 'Input frequency', ['ups'])

              def get_ups_data():
                  try:
                      result = subprocess.run(['upsc', 'ups@localhost'], capture_output=True, text=True, timeout=10)
                      if result.returncode != 0:
                          print(f"upsc error: {result.stderr}", file=sys.stderr)
                          return {}
                      data = {}
                      for line in result.stdout.strip().split('\n'):
                          if ':' in line:
                              key, value = line.split(':', 1)
                              data[key.strip()] = value.strip()
                      return data
                  except Exception as e:
                      print(f"Error getting UPS data: {e}", file=sys.stderr)
                      return {}

              def update_metrics():
                  data = get_ups_data()
                  if not data:
                      return

                  ups_name = 'ups'

                  if 'battery.charge' in data:
                      try:
                          battery_charge.labels(ups=ups_name).set(float(data['battery.charge']))
                      except: pass
                  if 'battery.runtime' in data:
                      try:
                          battery_runtime.labels(ups=ups_name).set(float(data['battery.runtime']))
                      except: pass
                  if 'input.voltage' in data:
                      try:
                          input_voltage.labels(ups=ups_name).set(float(data['input.voltage']))
                      except: pass
                  if 'output.voltage' in data:
                      try:
                          output_voltage.labels(ups=ups_name).set(float(data['output.voltage']))
                      except: pass
                  if 'ups.load' in data:
                      try:
                          ups_load.labels(ups=ups_name).set(float(data['ups.load']))
                      except: pass
                  if 'input.frequency' in data:
                      try:
                          input_frequency.labels(ups=ups_name).set(float(data['input.frequency']))
                      except: pass
                  if 'ups.status' in data:
                      # OL = Online (on mains), OB = On Battery
                      status_val = 1 if 'OL' in data['ups.status'] else 0
                      ups_status.labels(ups=ups_name).set(status_val)

              if __name__ == '__main__':
                  start_http_server(9199)
                  print("NUT Exporter started on port 9199", flush=True)
                  while True:
                      update_metrics()
                      time.sleep(15)
              PYEOF

              # Wait for NUT server to be ready
              echo "Waiting for NUT server..."
              while ! upsc ups@localhost > /dev/null 2>&1; do
                echo "NUT server not ready, retrying..."
                sleep 5
              done
              echo "NUT server ready, starting exporter..."

              exec python3 /exporter.py
          ports:
            - name: metrics
              containerPort: 9199
              protocol: TCP
          resources:
            requests:
              cpu: 5m
              memory: 32Mi
            limits:
              cpu: 50m
              memory: 64Mi
          livenessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 90
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 60
            periodSeconds: 10

      volumes:
        - name: scripts
          emptyDir: {}
        - name: tools
          emptyDir: {}
        - name: nut-config-template
          configMap:
            name: nut-config
        - name: nut-config
          emptyDir: {}
        - name: usb
          hostPath:
            path: /dev/bus/usb
            type: Directory
        - name: talosconfig
          secret:
            secretName: nut-secrets
            items:
              - key: talosconfig
                path: talosconfig

      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
