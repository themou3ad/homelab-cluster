---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nut-config
  namespace: kube-system
data:
  # UPS configuration - Driver for Master U Power (uses generic USB HID)
  ups.conf: |
    [ups]
        driver = usbhid-ups
        port = auto
        desc = "Master U Power UPS"
        pollinterval = 2

  # NUT server configuration
  upsd.conf: |
    LISTEN 0.0.0.0 3493
    MAXAGE 15

  # NUT users configuration
  upsd.users: |
    [admin]
        password = ${NUT_ADMIN_PASSWORD}
        actions = SET
        instcmds = ALL

    [upsmon]
        password = ${NUT_MONITOR_PASSWORD}
        upsmon master

    [exporter]
        password = ${NUT_EXPORTER_PASSWORD}
        upsmon slave

  # UPS monitor configuration
  upsmon.conf: |
    MONITOR ups@localhost 1 upsmon ${NUT_MONITOR_PASSWORD} master

    MINSUPPLIES 1
    SHUTDOWNCMD "/scripts/shutdown.sh"
    NOTIFYCMD "/scripts/notify.sh"
    POLLFREQ 5
    POLLFREQALERT 2
    HOSTSYNC 15
    DEADTIME 25
    POWERDOWNFLAG /etc/killpower
    RBWARNTIME 43200
    NOCOMMWARNTIME 300
    FINALDELAY 5

    # Notification flags
    NOTIFYFLAG ONLINE SYSLOG+EXEC
    NOTIFYFLAG ONBATT SYSLOG+EXEC
    NOTIFYFLAG LOWBATT SYSLOG+EXEC
    NOTIFYFLAG FSD SYSLOG+EXEC
    NOTIFYFLAG COMMOK SYSLOG
    NOTIFYFLAG COMMBAD SYSLOG+EXEC
    NOTIFYFLAG SHUTDOWN SYSLOG+EXEC
    NOTIFYFLAG REPLBATT SYSLOG+EXEC
    NOTIFYFLAG NOCOMM SYSLOG+EXEC

    # Custom notification messages
    NOTIFYMSG ONLINE "UPS %s: Alimentation secteur retablie"
    NOTIFYMSG ONBATT "UPS %s: Sur batterie - coupure de courant detectee"
    NOTIFYMSG LOWBATT "UPS %s: Batterie faible - shutdown imminent"
    NOTIFYMSG FSD "UPS %s: Forced shutdown en cours"
    NOTIFYMSG COMMOK "UPS %s: Communication retablie"
    NOTIFYMSG COMMBAD "UPS %s: Communication perdue"
    NOTIFYMSG SHUTDOWN "UPS %s: Arret systeme en cours"
    NOTIFYMSG REPLBATT "UPS %s: Batterie a remplacer"
    NOTIFYMSG NOCOMM "UPS %s: Communication impossible"

  # Shutdown script - drains Kubernetes node and shuts down Talos
  shutdown.sh: |
    #!/bin/sh
    set -e

    export PATH="/tools:$PATH"

    echo "$(date): UPS shutdown triggered - starting graceful shutdown sequence"

    # Send final notification
    /scripts/notify.sh "SHUTDOWN" "Arret systeme en cours - UPS batterie critique"

    # Get battery status for logging
    BATTERY_CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "unknown")
    BATTERY_RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "unknown")
    echo "$(date): Battery charge: ${BATTERY_CHARGE}%, Runtime: ${BATTERY_RUNTIME}s"

    # Drain the Kubernetes node
    echo "$(date): Draining Kubernetes node gurzil-one..."
    kubectl drain gurzil-one \
        --ignore-daemonsets \
        --delete-emptydir-data \
        --force \
        --grace-period=60 \
        --timeout=120s 2>&1 || echo "Warning: Node drain had issues, continuing with shutdown"

    echo "$(date): Node drain complete, initiating Talos shutdown..."

    # Shutdown Talos node
    talosctl shutdown \
        --talosconfig /etc/talos/talosconfig \
        --nodes 192.168.1.162 2>&1

    echo "$(date): Shutdown command sent to Talos"

  # Notification script - sends alerts to ntfy
  notify.sh: |
    #!/bin/sh

    NOTIFYTYPE="${1:-UNKNOWN}"
    MESSAGE="${UPSNAME:-ups}: ${2:-$NOTIFYTYPE}"

    # Determine priority and tags based on notification type
    case "$NOTIFYTYPE" in
        ONLINE)
            PRIORITY="default"
            TAGS="white_check_mark,zap"
            TITLE="UPS: Alimentation Retablie"
            ;;
        ONBATT)
            PRIORITY="high"
            TAGS="warning,battery"
            TITLE="UPS: Coupure de Courant"
            ;;
        LOWBATT)
            PRIORITY="urgent"
            TAGS="rotating_light,battery"
            TITLE="UPS: Batterie Faible"
            ;;
        FSD|SHUTDOWN)
            PRIORITY="urgent"
            TAGS="skull,electric_plug"
            TITLE="UPS: Arret Systeme"
            ;;
        COMMBAD|NOCOMM)
            PRIORITY="high"
            TAGS="x,electric_plug"
            TITLE="UPS: Communication Perdue"
            ;;
        REPLBATT)
            PRIORITY="default"
            TAGS="wrench,battery"
            TITLE="UPS: Batterie a Remplacer"
            ;;
        *)
            PRIORITY="default"
            TAGS="information_source"
            TITLE="UPS: Notification"
            ;;
    esac

    # Get additional UPS info if available
    BATTERY_INFO=""
    if command -v upsc >/dev/null 2>&1; then
        CHARGE=$(upsc ups@localhost battery.charge 2>/dev/null || echo "N/A")
        RUNTIME=$(upsc ups@localhost battery.runtime 2>/dev/null || echo "N/A")
        if [ "$CHARGE" != "N/A" ] || [ "$RUNTIME" != "N/A" ]; then
            RUNTIME_MIN=$((RUNTIME / 60))
            BATTERY_INFO="\nBatterie: ${CHARGE}% - Autonomie: ${RUNTIME_MIN}min"
        fi
    fi

    # Send to ntfy
    curl -s \
        -H "Title: ${TITLE}" \
        -H "Priority: ${PRIORITY}" \
        -H "Tags: ${TAGS}" \
        -d "${MESSAGE}${BATTERY_INFO}" \
        "http://ntfy.default.svc.cluster.local/alertes" || true

    echo "$(date): Notification sent: ${NOTIFYTYPE} - ${MESSAGE}"
