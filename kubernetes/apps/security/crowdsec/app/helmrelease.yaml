---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: security
spec:
  interval: 1h
  chart:
    spec:
      chart: crowdsec
      version: "0.17.0"
      sourceRef:
        kind: HelmRepository
        name: crowdsec
  values:
    container_runtime: containerd

    # LAPI (Local API) - central component
    lapi:
      replicas: 1
      env:
        - name: ENROLL_KEY
          valueFrom:
            secretKeyRef:
              name: crowdsec-keys
              key: enroll-key
        - name: ENROLL_INSTANCE_NAME
          value: "gurzil-homelab"
        - name: ENROLL_TAGS
          value: "k8s homelab"
        # Install HTTP notification plugin
        - name: PLUGIN_NOTIF_HTTP
          value: "true"

      # Notification configuration
      config:
        notifications:
          http.yaml: |
            type: http
            name: ntfy_alerts
            log_level: info
            format: |
              {
                "topic": "security",
                "title": "ðŸš¨ CrowdSec Alert",
                "message": "{{range .}}IP {{.Source_ip}} bloquee pour {{.Scenario}} ({{.Source_country}}){{end}}",
                "priority": "high",
                "tags": ["warning","skull"]
              }
            url: http://ntfy.default.svc.cluster.local/security
            method: POST
            headers:
              Content-Type: application/json

        profiles.yaml: |
          name: default_ip_remediation
          filters:
            - Alert.Remediation == true && Alert.GetScope() == "Ip"
          decisions:
            - type: ban
              duration: 4h
          notifications:
            - ntfy_alerts
          on_success: break

      persistentVolume:
        data:
          enabled: true
          storageClassName: longhorn-replicated
          size: 1Gi
        config:
          enabled: true
          storageClassName: longhorn-replicated
          size: 100Mi

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

    # Agent - collects and parses logs
    agent:
      env:
        - name: COLLECTIONS
          value: "crowdsecurity/linux crowdsecurity/nginx crowdsecurity/http-cve crowdsecurity/base-http-scenarios crowdsecurity/sshd"
        - name: PARSERS
          value: "crowdsecurity/cri-logs"

      acquisition:
        # Envoy Gateway access logs
        - namespace: network
          podName: envoy-*
          program: envoy
          poll_without_inotify: true

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

      persistentVolume:
        config:
          enabled: true
          storageClassName: longhorn-replicated
          size: 100Mi
